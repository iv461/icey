<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Developing ICEY" href="development.html" /><link rel="prev" title="Translating existing nodes to use ICEY: Autoware example" href="translating_an_autoware_node.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>Extending ICEY - icey 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #7C4DFF;
  --color-brand-content: #7C4DFF;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #7C4DFF;
  --color-brand-content: #7C4DFF;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">icey 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">icey 0.1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="using_parameter_structs.html">Using Parameters Structs for managing many parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="using_tf.html">Using TF</a></li>
<li class="toctree-l1"><a class="reference internal" href="translating_an_autoware_node.html">Translating existing nodes to use ICEY: Autoware example</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Extending ICEY</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Developing ICEY</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_reference.html">API Reference</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="_sources/extending_icey.md.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="extending-icey">
<h1>Extending ICEY<a class="headerlink" href="#extending-icey" title="Link to this heading">¶</a></h1>
<p>This tutorial shows how you can extend ICEY – add new publishers, subscribers,
but also new filters.</p>
<section id="the-stream-concept">
<h2>The Stream concept<a class="headerlink" href="#the-stream-concept" title="Link to this heading">¶</a></h2>
<p>For this, we first need to understand the concept <code class="docutils literal notranslate"><span class="pre">Stream</span></code> more in detail.
An <code class="docutils literal notranslate"><span class="pre">Stream</span></code> is a value with a list of callbacks that get called when this value changes.
We can set the value of the Stream, this triggers that all the callbacks get called.
We can also listen on changes to this value by registering a callback ourselves.</p>
</section>
<section id="extending-with-custom-subscribers-and-publishers-image-transport">
<h2>Extending with custom subscribers and publishers: ìmage_transport<a class="headerlink" href="#extending-with-custom-subscribers-and-publishers-image-transport" title="Link to this heading">¶</a></h2>
<p>In the following, we will extend ICEY to support the subscribers from the <code class="docutils literal notranslate"><span class="pre">ìmage_transport</span></code> package that allows subscribing to compressed camera images.</p>
<p>We already know how to create new subscribers: When we subscribe to a topic in ROS, we pass it a subscriber-callback that gets called every time a new message is received. We will create therefore an Stream that holds as value the ROS-message. We will set the value of the Stream to the new ROS-message each time the subscriber-callback gets called.</p>
<p>We create a new <code class="docutils literal notranslate"><span class="pre">ImageTransportSubscriber</span></code>-stream by deriving from the class <code class="docutils literal notranslate"><span class="pre">Stream</span></code>.
The class template <code class="docutils literal notranslate"><span class="pre">Stream&lt;Value,</span> <span class="pre">Error,</span> <span class="pre">DerivedImpl&gt;</span></code>
is parametrized on the <code class="docutils literal notranslate"><span class="pre">Value</span></code> it holds, for this we use the ROS-message type <code class="docutils literal notranslate"><span class="pre">sensor_msgs::Image::ConstSharedPtr</span> </code>.</p>
<p>TODO finish:</p>
<p>We first declare the <code class="docutils literal notranslate"><span class="pre">DerivedImpl</span></code>-class that holds everything this stream needs as data fields. The class that actually derives from <code class="docutils literal notranslate"><span class="pre">Stream</span></code> should never contain any fields.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">ImageTransportSubscriberImpl</span><span class="w">  </span><span class="p">{</span>
<span class="w">  </span><span class="c1">/// The image_transport subs/pubs use PIMPL, so we can hold them by value.</span>
<span class="w">  </span><span class="n">image_transport</span><span class="o">::</span><span class="n">Subscriber</span><span class="w"> </span><span class="n">subscriber</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ImageTransportSubscriber</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Stream</span><span class="o">&lt;</span><span class="w"> </span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Image</span><span class="o">::</span><span class="n">ConstSharedPtr</span><span class="p">,</span>
<span class="w">                    </span><span class="n">image_transport</span><span class="o">::</span><span class="n">TransportLoadException</span><span class="p">,</span><span class="w"> </span><span class="n">ImageTransportSubscriberImpl</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
</pre></div>
</div>
<p>We can now write the constructor that takes the arguments we need for the subscriber – topic name, QoS:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ImageTransportSubscriber</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">icey</span><span class="o">::</span><span class="n">Stream</span><span class="o">&lt;</span><span class="w"> </span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">Image</span><span class="o">::</span><span class="n">ConstSharedPtr</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ImageTransportSubscriber</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">topic_name</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">transport</span><span class="p">,</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">QoS</span><span class="w"> </span><span class="n">qos</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">iamge_transport</span><span class="o">::</span><span class="n">Subscriber</span><span class="w"> </span><span class="n">subscriber_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>we also created the field <code class="docutils literal notranslate"><span class="pre">subscriber_</span></code> to store the subscriber we will create.</p>
<section id="attaching-to-the-ros-node">
<h3>Attaching to the ROS-Node<a class="headerlink" href="#attaching-to-the-ros-node" title="Link to this heading">¶</a></h3>
<p>Now comes the important part: The <em>attaching</em> to the ROS-Node. In ICEY, attaching means actually creating the subscriber/publishers/timers etc in the ROS-node. We do not do this immediatelly after constructing the Streams, instead we defer this process. It happens when the  method <code class="docutils literal notranslate"><span class="pre">attach</span></code> is called.</p>
<p>We implement the method attach with a lambda-function, capturing by value (copying inside the lambda) all the parameters required for the subscriber:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ImageTransportSubscriber</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">icey</span><span class="o">::</span><span class="n">Stream</span><span class="o">&lt;</span><span class="w"> </span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">Image</span><span class="o">::</span><span class="n">ConstSharedPtr</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ImageTransportSubscriber</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">topic_name</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">transport</span><span class="p">,</span><span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">QoS</span><span class="w"> </span><span class="n">qos</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">impl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">attach_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">impl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">impl</span><span class="p">(),</span><span class="w"> </span><span class="n">topic_name</span><span class="p">,</span><span class="w"> </span><span class="n">transport</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">](</span><span class="n">icey</span><span class="o">::</span><span class="n">NodeBookkeeping</span><span class="w"> </span><span class="o">&amp;</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">impl</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">subscriber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image_transport</span><span class="o">::</span><span class="n">create_subscriber</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">transport</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">,</span><span class="w"> </span><span class="n">subscriber_callback</span><span class="p">);</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<blockquote>
<div><p>Note: <code class="docutils literal notranslate"><span class="pre">this-&gt;</span></code> is important in the following to tell the compiler to look in the base class, otherwise it cannot find the function</p>
</div></blockquote>
<p>We now created the subscriber as we normally would in ROS.</p>
</section>
<section id="setting-the-value-of-the-stream">
<h3>Setting the value of the Stream<a class="headerlink" href="#setting-the-value-of-the-stream" title="Link to this heading">¶</a></h3>
<p>We now make the Stream do something by implementing the subscriber callback to set the value.
The stream stores a promise that we first get with <code class="docutils literal notranslate"><span class="pre">get_promise</span></code> and then <code class="docutils literal notranslate"><span class="pre">resolve</span></code> it with the message inside the callback:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ImageTransportSubscriber</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">icey</span><span class="o">::</span><span class="n">Stream</span><span class="o">&lt;</span><span class="w"> </span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">Image</span><span class="o">::</span><span class="n">ConstSharedPtr</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ImageTransportSubscriber</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">topic_name</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">transport</span><span class="p">,</span><span class="w">  </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">QoS</span><span class="w"> </span><span class="n">qos</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">promise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_promise</span><span class="p">();</span><span class="w"> </span><span class="c1">/// Get the promise holding the value</span>
<span class="w">        </span><span class="c1">/// Now implement the callabck to resolve with the message:</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">subscriber_callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">promise</span><span class="p">](</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">Image</span><span class="o">::</span><span class="n">ConstSharedPtr</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">promise</span><span class="o">-&gt;</span><span class="n">resolve</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">attach_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">topic_name</span><span class="p">,</span><span class="w"> </span><span class="n">transport</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">](</span><span class="n">icey</span><span class="o">::</span><span class="n">NodeBookkeeping</span><span class="w"> </span><span class="o">&amp;</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">subscriber_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image_transport</span><span class="o">::</span><span class="n">create_subscriber</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">transport</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">subscriber_callback</span><span class="p">);</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">iamge_transport</span><span class="o">::</span><span class="n">Subscriber</span><span class="w"> </span><span class="n">subscriber_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>And that’s it already ! We have created a custom subscriber stream. To use it, we use the function <code class="docutils literal notranslate"><span class="pre">create_stream&lt;T&gt;</span></code> with our custom stream:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">image_transport_sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icey</span><span class="o">::</span><span class="n">create_stream</span><span class="o">&lt;</span><span class="n">ImageTransportSubscriber</span><span class="o">&gt;</span><span class="p">(</span><span class="n">topic_name</span><span class="p">,</span><span class="w"> </span><span class="n">transport</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">);</span>
</pre></div>
</div>
<p>or using the class-based API:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">image_transport_sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icey</span><span class="p">().</span><span class="n">create_stream</span><span class="o">&lt;</span><span class="n">ImageTransportSubscriber</span><span class="o">&gt;</span><span class="p">(</span><span class="n">topic_name</span><span class="p">,</span><span class="w"> </span><span class="n">transport</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="writing-a-publisher">
<h3>Writing a publisher<a class="headerlink" href="#writing-a-publisher" title="Link to this heading">¶</a></h3>
<p>Creating a custom publisher is very similar to the subscriber, but this time we react on changes and publish to ROS. We again use <code class="docutils literal notranslate"><span class="pre">image_transport</span></code> as an example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ImageTransportPublisher</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">icey</span><span class="o">::</span><span class="n">Stream</span><span class="o">&lt;</span><span class="w"> </span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">Image</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ImageTransportPublisher</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">topic_name</span><span class="p">,</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">QoS</span><span class="w"> </span><span class="n">qos</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">promise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_promise</span><span class="p">();</span><span class="w"> </span><span class="c1">/// Get the promise holding the value</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">attach_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">topic_name</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">](</span><span class="n">icey</span><span class="o">::</span><span class="n">NodeBookkeeping</span><span class="w"> </span><span class="o">&amp;</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">/// Create the publisher</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">publisher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image_transport</span><span class="o">::</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">);</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This time however, we listen to changes of the Stream by calling <code class="docutils literal notranslate"><span class="pre">register_handler</span></code> on the promise and publish the message:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ImageTransportPublisher</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">icey</span><span class="o">::</span><span class="n">Stream</span><span class="o">&lt;</span><span class="w"> </span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">Image</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ImageTransportPublisher</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">topic_name</span><span class="p">,</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">QoS</span><span class="w"> </span><span class="n">qos</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">promise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_promise</span><span class="p">();</span><span class="w"> </span><span class="c1">/// Get the promise holding the value</span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">attach_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">promise</span><span class="p">,</span><span class="w"> </span><span class="n">topic_name</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">](</span><span class="n">icey</span><span class="o">::</span><span class="n">NodeBookkeeping</span><span class="w"> </span><span class="o">&amp;</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">/// Create the publisher</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">publisher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">image_transport</span><span class="o">::</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">);</span>

<span class="w">            </span><span class="n">promise</span><span class="o">-&gt;</span><span class="n">register_handler</span><span class="p">([</span><span class="n">publisher</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">new_state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">publisher</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">promise</span><span class="p">.</span><span class="n">value</span><span class="p">());</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="error-handling">
<h3>Error handling<a class="headerlink" href="#error-handling" title="Link to this heading">¶</a></h3>
<p>TODO
Streams also support error handling, they can hold an <code class="docutils literal notranslate"><span class="pre">ErrorValue</span></code>:</p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="development.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Developing ICEY</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="translating_an_autoware_node.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Translating existing nodes to use ICEY: Autoware example</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Ivo Ivanov
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Extending ICEY</a><ul>
<li><a class="reference internal" href="#the-stream-concept">The Stream concept</a></li>
<li><a class="reference internal" href="#extending-with-custom-subscribers-and-publishers-image-transport">Extending with custom subscribers and publishers: ìmage_transport</a><ul>
<li><a class="reference internal" href="#attaching-to-the-ros-node">Attaching to the ROS-Node</a></li>
<li><a class="reference internal" href="#setting-the-value-of-the-stream">Setting the value of the Stream</a></li>
<li><a class="reference internal" href="#writing-a-publisher">Writing a publisher</a></li>
<li><a class="reference internal" href="#error-handling">Error handling</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=01f34227"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>