name: ROS 2 Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ros_distro:
          - humble
          - jazzy

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Docker image caching
      - name: Cache Docker image
        uses: actions/cache@v4
        with:
          path: /tmp/.docker-cache-${{ matrix.ros_distro }}
          key: docker-${{ matrix.ros_distro }}-${{ github.sha }}
          restore-keys: |
            docker-${{ matrix.ros_distro }}-

      - name: Run ROS 2 in Docker
        uses: ika-rwth-aachen/docker-ros@v1.8.1
        with:
          base-image: rwthika/ros2:${{ matrix.ros_distro }}
          run: |
            cd /github/workspace
            apt-get update && apt-get install -y python3-rosdep
            rosdep init || true
            rosdep update
            rosdep install --from-paths src --ignore-src -r -y
            colcon build --symlink-install --event-handlers console_direct+